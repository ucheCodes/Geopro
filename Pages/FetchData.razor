@page "/test"

@using OxyPlot
@using OxyPlot.Axes
@using OxyPlot.Annotations
@using OxyPlot.Blazor

<BlazorPlotView Model="@plotModel"/>

@code {
    private PlotModel plotModel = new();

    protected override void OnInitialized()
    {
        ///plotModel = new PlotModel { Title = "Rectangle with Text" };
        string text = $"Hello\n02";
        CreateRectangleWithTextRotationalAngle(plotModel,1,1.4,1,1.3,"DR",OxyColors.Red);
        DrawRectangleArrowHeadAndText(plotModel,2, 2.5, 0, 4, OxyColors.LightGray, OxyColors.Black,OxyColors.Red, "string text");
        CreateRectangleWithTextOld(plotModel,text,2.5,3,0,4);
        DrawRectangleArrowHead(plotModel, 3.5,4,1,4, OxyColors.LightGray, OxyColors.Black,ArrowDirection.up);
    }
    private void CreateRectangleAndParrallelText(PlotModel plotModel)
    {
        
    }
    private void CreateRectangleWithTextRotationalAngle(PlotModel plotModel, double x0, double x1, double y0, double y1, string text, OxyColor fillColor)
    {
        //valid and working
        double fontsize = 12;
        double rectLength = y1 - y0;

        // Define axes
        plotModel.Axes.Add(new LinearAxis { Position = AxisPosition.Top, Minimum = 0, Maximum = 10 });
        plotModel.Axes.Add(new LinearAxis { StartPosition = 0, EndPosition = 1, Position = AxisPosition.Left, Minimum = 0, Maximum = 10 });

        // Add a rectangle annotation
        var rectangleAnnotation = new RectangleAnnotation
        {
            MinimumX = x0,
            MaximumX = x1,
            MinimumY = y0,
            MaximumY = y1,
            Fill = fillColor,
            Stroke = OxyColors.Black,
            StrokeThickness = 1
        };
        plotModel.Annotations.Add(rectangleAnnotation);

        // Custom annotation to draw vertical text
        if(rectLength < 1 && text.Length >= 4)
        {
            fontsize = 10;
        }
        else if(rectLength >= 1 && text.Length >= 7)
        {
            fontsize = 12;
        }
        var customTextAnnotation = new CustomTextAnnotation
        {
            Text = text,//"This is a text inside the rectangle",
            Rectangle = rectangleAnnotation,
            FontSize = fontsize,
            TextColor = OxyColors.White,
            RotationAngle = 270
        };
        plotModel.Annotations.Add(customTextAnnotation);
    }
    private void DrawRectangleArrowHeadAndText(PlotModel plotModel,double x0, double x1, double y0, double y1, OxyColor fillColor, OxyColor lineColor,OxyColor textColor, string text)
    {
        //valid and working
        var customAnnotation = new CustomRectangleWithArrowAndTextAnnotation
        {
            MinimumX = x0,
            MaximumX = x1,
            MinimumY = y0,
            MaximumY = y1,
            FontSize = 16,
            Text = text,
            TextRotationAngle = 90,
            FillColor = fillColor,
            LineColor = lineColor,
            TextColor = textColor,
            LineThickness = 2,
            ArrowHeadLength = 15
        };
        plotModel.Annotations.Add(customAnnotation);
    }
    
    private void DrawRectangleArrowHead(PlotModel plotModel,double x0, double x1, double y0, double y1, OxyColor fillColor, OxyColor lineColor, ArrowDirection direction)
    {
        //valid and working
        var customAnnotation = new CustomRectangleWithArrowAnnotation
        {
            MinimumX = x0,
            MaximumX = x1,
            MinimumY = y0,
            MaximumY = y1,
            FontSize = 16,
            FillColor = fillColor,
            LineColor = lineColor,
            LineThickness = 2,
            ArrowHeadLength = 15,
            ArrowDirection = direction
        };
        plotModel.Annotations.Add(customAnnotation);
    }


    private void CreateRectangleWithTextOld(PlotModel plotModel,string text, double x0, double x1, double y0, double y1)
    {
        // Define axes
        //plotModel.Axes.Add(new LinearAxis { Position = AxisPosition.Bottom, Minimum = 0, Maximum = 10 });
        //plotModel.Axes.Add(new LinearAxis { Position = AxisPosition.Left, Minimum = 0, Maximum = 10 });

        // Add a rectangle annotation
        var rectangleAnnotation = new RectangleAnnotation
        {
            MinimumX = x0,
            MaximumX = x1,
            MinimumY = y0,
            MaximumY = y1,
            Fill = OxyColors.Transparent,
            Stroke = OxyColors.Black,
            StrokeThickness = 1
        };
        plotModel.Annotations.Add(rectangleAnnotation);

        // Add a text annotation
        var textAnnotation = new TextAnnotation
        {
            Text = text,
            TextPosition = new DataPoint((x0 + x1) / 2, 
                                         (y0 + y1) / 2),
            FontSize = 16,
            //TextColor = OxyColors.White,
            TextHorizontalAlignment = HorizontalAlignment.Center,
            TextVerticalAlignment = VerticalAlignment.Middle,
            Stroke = OxyColors.Transparent
        };
        plotModel.Annotations.Add(textAnnotation);
    }
    public PlotModel CreateRectangleWithWrappedText(double minX, double maxX, double minY, double maxY)
    {
        var plotModel = new PlotModel { Title = "Rectangles with Hatches and Wrapped Text" };
        plotModel.Axes.Add(new LinearAxis { Position = AxisPosition.Top, Minimum = 0, Maximum = 10 });
        plotModel.Axes.Add(new LinearAxis { Position = AxisPosition.Left, StartPosition = 1, EndPosition = 0, Minimum = 0, Maximum = 10 });

        // Add rectangle with hatch pattern
        plotModel.Annotations.Add(CreateRectangle(minX, maxX, minY, maxY, OxyColors.Transparent, HatchStyle.None));

        // Add wrapped text inside the rectangle
        AddWrappedText(plotModel, "This is a text inside the rectangle that's meant to stay within the bounds of the rectangle and not overflow", minX, maxX, minY, maxY);

        return plotModel;
    }

    private void AddWrappedText(PlotModel plotModel, string text, double minX, double maxX, double minY, double maxY)
    {
        double fontSize = 14;
        double padding = 2;

        var textLines = WrapText(text, maxX - minX - 2 * padding, fontSize);

        double lineHeight = fontSize * 1.2; // Approximate line height
        double totalTextHeight = textLines.Count * lineHeight;

        double currentY = maxY - padding; // Start from the top of the rectangle and move down

        foreach (var line in textLines)
        {
            var textAnnotation = new TextAnnotation
            {
                Text = line,
                TextPosition = new DataPoint((minX + maxX) / 2, currentY),
                FontSize = fontSize,
                FontWeight = FontWeights.Bold,
                TextHorizontalAlignment = HorizontalAlignment.Center,
                TextVerticalAlignment = VerticalAlignment.Top,
                TextColor = OxyColors.Black,
                Stroke = OxyColors.Transparent
            };

            plotModel.Annotations.Add(textAnnotation);
            currentY -= lineHeight; // Move to the next line
        }
    }

    private List<string> WrapText(string text, double maxWidth, double fontSize)
    {
        List<string> lines = new List<string>();
        string[] words = text.Split(' ');
        string currentLine = string.Empty;

        foreach (var word in words)
        {
            string testLine = string.IsNullOrEmpty(currentLine) ? word : currentLine + " " + word;
            double testWidth = EstimateTextWidth(testLine, fontSize);

            if (testWidth <= maxWidth)
            {
                currentLine = testLine;
            }
            else
            {
                if (!string.IsNullOrEmpty(currentLine))
                {
                    lines.Add(currentLine);
                }
                currentLine = word;
            }
        }

        if (!string.IsNullOrEmpty(currentLine))
        {
            lines.Add(currentLine);
        }

        return lines;
    }

    private double EstimateTextWidth(string text, double fontSize)
    {
        // This is a rough estimation. You might need to adjust this based on your font and rendering settings.
        // The constant value here (0.6) can be tweaked to better match your actual text width.
        return text.Length * fontSize * 0.6;
    }

    private RectangleAnnotation CreateRectangle(double minX, double maxX, double minY, double maxY, OxyColor color, HatchStyle hatchStyle)
    {
        // Implement your rectangle creation logic here
        return new RectangleAnnotation
        {
            MinimumX = minX,
            MaximumX = maxX,
            MinimumY = minY,
            MaximumY = maxY,
            Fill = color,
            Stroke = OxyColors.Black,
            StrokeThickness = 1
        };
    }
//}

    //end
}